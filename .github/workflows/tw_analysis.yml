name: TW Post-Market AI (Threads Auto Post)

on:
  schedule:
    - cron: '30 7 * * 1-5' # åœ‹éš›æ¨™æº–æ™‚é–“ 07:30 = å°åŒ—æ™‚é–“ 15:30 (é€±ä¸€è‡³é€±äº”)
  workflow_dispatch: # ä¿ç•™æ‰‹å‹•åŸ·è¡ŒæŒ‰éˆ•ï¼Œé€™å°æ¸¬è©¦éå¸¸æœ‰ç”¨

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ç¢ºä¿ Actions æœ‰æ¬Šé™æŠŠ csv æª”æ¡ˆæ¨å›å€‰åº«
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # é€™è£¡åŠ å…¥ token ç¢ºä¿å¾ŒçºŒ push æ¬Šé™
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          # å¦‚æœæ²’æœ‰ requirements.txtï¼Œå¯ä»¥æ‰‹å‹•å®‰è£ requests
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests
          fi

      - name: Analyze Market and Post to Threads
        env:
          # å°æ¥ä½ åœ¨ Settings è¨­å®šçš„é•·æ•ˆ Token
          THREADS_TOKEN: ${{ secrets.THREADS_TOKEN }}
        run: python run_tw.py

      - name: Commit and Save History
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # åªæœ‰ç•¶æª”æ¡ˆå­˜åœ¨ä¸”æœ‰è®Šå‹•æ™‚æ‰ commit
          if [ -f tw_history.csv ]; then
            git add tw_history.csv
            if git diff --staged --quiet; then
              echo "No changes to history file."
            else
              git commit -m "ğŸ“ˆ Update stock history: $(date +'%Y-%m-%d')"
              git push
            fi
          fi
